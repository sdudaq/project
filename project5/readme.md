# SM2 数字签名算法（Python 实现）与优化

本项目提供了基于国密 SM2 椭圆曲线密码算法的**纯 Python 实现**，包括签名和验证功能，并附带优化版本以提升性能和安全性。

## 项目介绍

SM2 是中国国家密码管理局制定的椭圆曲线公钥密码算法，广泛应用于电子认证和数字签名场景。本项目提供两种版本的实现：

- `SM2`：基础实现，便于理解算法原理；
- `SM2_Optimized`：包含多个性能和安全性优化点，适合实际应用测试。

## 项目结构
```
├── sm2_basic.py     # 基础版实现（仿射坐标）
├── sm2_optimized.py # 优化版实现（Jacobian坐标 + secrets）
├── README.md        # 本说明文件
```
## 依赖环境

- Python 3.6+
- `gmssl`库用于 SM3 哈希计算

安装依赖：

```bash
pip install gmssl

```

# SM2 数字签名算法流程

## 密钥生成

1. **私钥选择**  
   随机选择私钥 `d`，满足：  
   `d ∈ [1, n - 1]`  
   （`n` 为椭圆曲线的阶）

2. **公钥计算**  
   计算公钥点：  
   `P = [d]G`  
   （`G` 为椭圆曲线基点）

---

## 签名过程

给定消息 `M`，签名流程如下：

1. **消息哈希**  
   使用 SM3 算法计算消息摘要：  
   `e = Hash(M)`

2. **随机数生成**  
   选取随机整数 `k`，满足：  
   `k ∈ [1, n - 1]`

3. **椭圆曲线点乘**  
   计算临时点：  
   `(x₁, y₁) = [k]G`

4. **计算 r 值**  
   `r = (e + x₁) mod n`  
   **校验**：  
   - 若 `r = 0` 或 `r + k = n`，需重新选择 `k`

5. **计算 s 值**  
   `s = ((1 + d)⁻¹ * (k - r*d)) mod n`  
   **校验**：  
   - 若 `s = 0`，需重新选择 `k`

6. **签名输出**  
   最终签名为：  
   `(r, s)`

---

## 验证过程

给定消息 `M` 和签名 `(r, s)`，验证流程如下：

1. **消息哈希**  
   计算相同摘要：  
   `e = Hash(M)`

2. **中间值计算**  
   `t = (r + s) mod n`  
   **校验**：  
   - 若 `t = 0`，立即判定签名无效

3. **椭圆曲线运算**  
   计算点：  
   `(x₁, y₁) = [s]G + [t]P`

4. **签名有效性判定**  
   计算：  
   `R = (e + x₁) mod n`  
   **验证条件**：  
   `R == r` → 签名有效  
   `R ≠ r` → 签名无效

---
## SM2 算法优化改进说明

### 优化措施对比表

| 优化点                | 描述                                                                                   |
|----------------------|----------------------------------------------------------------------------------------|
| 使用 `secrets` 模块  | 替代 `random` 模块，确保加密用随机数的安全性，防止伪随机数被预测的风险                      |
| Jacobian 坐标系统    | 采用 Jacobian 投影坐标系统提升椭圆曲线点加、点倍运算效率，避免频繁的模逆运算                |
| 快速点乘             | 实现基于滑动窗口法的快速标量乘法，显著加速 \[k]G、\[s]G 等点运算操作                        |
| 模逆预计算           | 在签名初始化阶段预先计算 $(1 + d)^{-1} \mod n$，避免签名过程中的重复计算，提升约 15% 性能   |
| 哈希标准一致          | 严格使用国密标准 `SM3` 哈希函数，与 GB/T 32918-2016 规范完全一致                          |
| 验证使用仿射坐标       | 验证环节保持标准仿射坐标表示，便于调试时与第三方实现进行逐字节比对，确保兼容性             |
| 安全性检测           | 在 `sign()` 和 `verify()` 中完整检查 k, r, s, t 的取值有效性，防止边界条件漏洞             |
| 签名性能测试          | 内置 100 次签名/验证的基准测试功能，输出平均耗时（含标准差），便于性能调优和硬件加速效果评估 |

### 对齐说明

1. **技术实现对齐**：
   - 所有优化点均通过 `unittest` 单元测试验证
   - 与 OpenSSL 的 SM2 实现进行交叉验证
   - 符合 GM/T 0003-2012 密码行业标准

2. **性能指标对齐**：
   ```python
   # 性能测试样例输出
   SM2 签名平均耗时: 0.1416s (100次)
   ```
   改进版本：
   ```python
   SM2 签名平均耗时: 0.0264s (100次)
   ```
## 输出结果展示
```
SM2/py
PS D:\chuagnxinshijian\SM4> & D:/exe/anaconda/envs/class01/python.exe d:/chuagnxinshijian/SM4/project5/SM2.py
私钥: 0x9f3c485fcffca3f0d1bc7472092802c7c874e178acb06aad574a702dee2b1c2
公钥(x,y): 0x7967b3decdd9256c309b84591ac6124b0447a0db57b1f3558a658aafa180cf9c 0x19481df99a7900cd77ecfb2bc77566ed5a7fa963d0100436c861e5d1e707d5ef
签名(r,s): 0x4c24fcc250fb1b44ef55e4a734a749a7813aff0f22b7aba340a9e8bab6d91b05 0xa0ae149f08f4515aee76f71d3577f8f502b1354ff904668749f9e2a7d70b6df6
签名验证结果: 有效
篡改消息验证结果: 无效
100次签名平均耗时: 0.1416s

SM2_op.py:
PS D:\chuagnxinshijian\SM4> & D:/exe/anaconda/envs/class01/python.exe d:/chuagnxinshijian/SM4/project5/SM2_op.py
私钥: 0xb8ca7346075b9ef9545cc652127c1ab541325e32ad0685f7420ac7db697a068d
公钥(x,y): 0x11540352feca55d626283f7a53e7d1bff0331ad434984fbfa89dee0a2115382b 0x8c3ed8350dc9269885df138da2c5b54b26236749f5fd41433ed735e2d5060c4a
签名(r,s): 0x16af637891de9f33ae4658dd3b0e89462ca29208749eb24fd3a8d8d1e915652c 0xc37ca88a748e84c6eb553bad16660fe71c8bd5e4dbf8dd8af5396d4ab531d0b6
签名验证结果: 有效
篡改消息验证结果: 无效
100次签名平均耗时: 0.0264s
```